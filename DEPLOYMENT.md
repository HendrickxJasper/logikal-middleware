# DigitalOcean App Platform Deployment Guide

## Prerequisites

1. DigitalOcean account with App Platform access
2. GitHub repository: `HendrickxJasper/logikal-middleware`
3. Environment variables configured

## Required Environment Variables

### Security Variables (Set as SECRET in DigitalOcean)
- `SECRET_KEY` - FastAPI secret key (generate with: `openssl rand -hex 32`)
- `JWT_SECRET_KEY` - JWT signing key (generate with: `openssl rand -hex 32`)
- `DATABASE_URL` - PostgreSQL connection string (auto-generated by DigitalOcean)
- `REDIS_URL` - Redis connection string (if using managed Redis)
- `LOGIKAL_AUTH_USERNAME` - Logikal API username
- `LOGIKAL_AUTH_PASSWORD` - Logikal API password
- `ADMIN_USERNAME` - Admin UI username
- `ADMIN_PASSWORD` - Admin UI password

### Public Variables
- `ENVIRONMENT=production`
- `DEBUG=false`
- `LOGIKAL_API_BASE_URL=http://128.199.57.77/MbioeService.svc/api/v3/`
- `ADMIN_SESSION_EXPIRE_HOURS=8`
- `LOG_LEVEL=INFO`
- `LOG_FORMAT=json`
- `PROMETHEUS_ENABLED=true`
- `RATE_LIMIT_PER_MINUTE=1000`
- `RATE_LIMIT_PER_HOUR=10000`

## Deployment Steps

### 1. Create App from GitHub
1. Go to DigitalOcean App Platform
2. Click "Create App"
3. Select "GitHub" as source
4. Choose repository: `HendrickxJasper/logikal-middleware`
5. Select branch: `main`
6. Choose "Dockerfile" as build method

### 2. Configure App Settings
- **App Name**: `logikal-middleware`
- **Dockerfile Path**: `Dockerfile`
- **HTTP Port**: `8080`
- **Instance Size**: `Basic XXS` (1 vCPU, 512MB RAM)
- **Instance Count**: `1`

### 3. Add Managed Database
1. In App Platform, go to "Databases" tab
2. Click "Create Database"
3. Choose PostgreSQL 15
4. Select `db-s-dev-database` size
5. Name: `logikal-db`

### 4. Configure Environment Variables
Set all required environment variables in the App Platform dashboard:
- Mark sensitive variables as "SECRET"
- Use the values from your local `.env` file

### 5. Configure Health Check
- **Path**: `/api/v1/health`
- **Port**: `8080`

### 6. Configure Routes
Add the following routes:
- `/` - Main UI
- `/ui` - Admin UI
- `/api` - API endpoints
- `/docs` - API documentation
- `/redoc` - Alternative API docs
- `/metrics` - Prometheus metrics

## Post-Deployment

### 1. Run Database Migrations
```bash
# Connect to the app and run migrations
doctl apps create-deployment <app-id> --force-rebuild
```

### 2. Test the Application
- Visit the app URL provided by DigitalOcean
- Test admin login with configured credentials
- Verify all API endpoints are working

### 3. Configure Custom Domain (Optional)
1. Go to App Platform settings
2. Add custom domain
3. Configure DNS records as instructed

## Monitoring and Logs

- **Logs**: Available in DigitalOcean App Platform dashboard
- **Metrics**: Available at `/metrics` endpoint
- **Health**: Monitored via `/api/v1/health` endpoint

## Security Considerations

1. **HTTPS**: Automatically enabled by DigitalOcean
2. **Environment Variables**: Sensitive data stored as secrets
3. **Database**: Managed PostgreSQL with automatic backups
4. **Rate Limiting**: Configured to prevent abuse
5. **Admin Authentication**: JWT-based with configurable expiration

## Scaling

To scale the application:
1. Go to App Platform dashboard
2. Edit the service
3. Increase instance count or size
4. Deploy changes

## Backup and Recovery

- **Database**: Automatic daily backups (managed by DigitalOcean)
- **Code**: Version controlled in GitHub
- **Configuration**: Stored in App Platform

## Troubleshooting

### Common Issues
1. **Build Failures**: Check Dockerfile and requirements.txt
2. **Multiple Apps Detected**: Ensure only one Dockerfile exists (development Dockerfile renamed to Dockerfile.dev)
3. **Database Connection**: Verify DATABASE_URL environment variable
4. **Authentication**: Check JWT_SECRET_KEY and admin credentials
5. **Health Check**: Ensure `/api/v1/health` endpoint is working

### Logs
- View application logs in DigitalOcean dashboard
- Check build logs for deployment issues
- Monitor health check status
